{"version":3,"sources":["webpack:///./routes/chat/style.css","webpack:///./routes/chat/index.tsx"],"names":["ChatItem","props","item","color","substr","message","length","style","Chat","ref","createRef","inputRef","statusRef","useState","items","setItems","chatFetchAborter","AbortController","useEffect","renderCallbackID","renderTimeoutID","updateTimeoutID","element","current","inputElement","statusElement","alive","paused","connected","mouseDown","mouseLeftDownY","lastMessage","position","velocity","Math","random","acceleration","free","handleBlur","window","addEventListener","handleFocus","handleMouseDown","event","button","clientY","preventDefault","handleMouseUp","focus","handleContextMenu","handleMouseMove","backgroundPosition","handleTouchDown","touches","pageY","handleTouchUp","handleTouchMove","console","log","error","render","setTimeout","requestAnimationFrame","abs","update","params","value","encodeURIComponent","fetch","then","res","json","data","innerText","display","catch","err","alert","location","reload","cancelAnimationFrame","abort","clearTimeout","removeEventListener","class","Helmet","title","autofocus","map","key"],"mappings":"0IACe,EAAQ,cCQjBA,EAA+C,SAACC,GACpD,IAAQC,EAASD,EAATC,KACFC,EAAQD,EAAKE,QAAQ,GACrBC,EAAUH,EAAKE,OAAO,EAAGF,EAAKI,OAAO,GAC3C,OAAO,kBAAIC,MAAO,CAACJ,MAAO,IAAIA,IAAWE,IAiN5BG,UA9MmB,WAChC,IAAMC,EAAMC,sBACNC,EAAWD,sBACXE,EAAYF,sBAClB,EAA0BG,YAAmB,IAAtCC,EAAP,KAAcC,EAAd,KACMC,EAAmB,IAAIC,gBA2L7B,OAzLAC,aAAU,WACR,IAUIC,EACAC,EACAC,EAZEC,EAAUb,EAAIc,QACdC,EAAeb,EAASY,QACxBE,EAAgBb,EAAUW,QAE5BG,GAAQ,EACRC,GAAS,EACTC,GAAY,EACZC,EAAY,EACZC,EAAiB,EACjBC,EAAc,GAIdC,EAAW,EACXC,EAAW,EAAI,EAAIC,KAAKC,SACxBC,EAAe,EAAI,GAAKF,KAAKC,SAC7BE,GAAO,EAELC,EAAa,WACjBX,GAAS,GAEXY,OAAOC,iBAAiB,OAAQF,GAEhC,IAAMG,EAAc,WAClBd,GAAS,GAEXY,OAAOC,iBAAiB,QAASC,GAEjC,IAAMC,EAAkB,SAACC,GAMvB,OALAd,GAAc,GAAGc,EAAMC,OACJ,IAAfD,EAAMC,SACRd,EAAiBa,EAAME,SAEzBF,EAAMG,kBACC,GAETP,OAAOC,iBAAiB,YAAaE,GAErC,IAAMK,EAAgB,SAACJ,GAQrB,OAPAd,GAAc,GAAGc,EAAMC,OACJ,IAAfD,EAAMC,SACRR,EAAe,EACfH,GAAY,GAEdT,EAAawB,QACbL,EAAMG,kBACC,GAETP,OAAOC,iBAAiB,UAAWO,GAEnC,IAAME,EAAoB,SAACN,GAEzB,OADAA,EAAMG,kBACC,GAETP,OAAOC,iBAAiB,cAAeS,GAEvC,IAAMC,EAAkB,SAACP,GACT,EAAVd,IACFI,EAAWU,EAAME,QAAUf,EAC3BA,EAAiBa,EAAME,QAEvBvB,EAAQf,MAAM4C,mBAAd,MADAnB,GAAYC,GACZ,OAGJM,OAAOC,iBAAiB,YAAaU,GAErC,IAAME,EAAkB,SAACT,GAIvB,OAFAN,GAAO,EACPP,EAAiBa,EAAMU,QAAQ,GAAGC,OAC3B,GAETf,OAAOC,iBAAiB,aAAcY,GAEtC,IAAMG,EAAgB,WAKpB,OAHAlB,GAAO,EACPD,EAAe,EACfH,GAAY,GACL,GAETM,OAAOC,iBAAiB,WAAYe,GAEpC,IAAMC,EAAkB,SAACb,GACI,IAAvBA,EAAMU,QAAQ/C,QAChB2B,EAAWU,EAAMU,QAAQ,GAAGC,MAAQxB,EACpCA,EAAiBa,EAAMU,QAAQ,GAAGC,MAElChC,EAAQf,MAAM4C,mBAAd,MADAnB,GAAYC,GACZ,MAE8B,IAAvBU,EAAMU,QAAQ/C,OACrBmD,QAAQC,IAAIf,EAAMU,SAGlBI,QAAQE,MAAM,uBAGlBpB,OAAOC,iBAAiB,YAAagB,IActB,SAATI,IACAjC,EACFP,EAAkByC,WAAWD,EAAQ,MAGrCzC,EAAmBoB,OAAOuB,sBAAsBF,GAhBlC,EAAV/B,IAAcQ,IAElBL,GADAC,GAAYG,EAGRF,KAAK6B,IAAI9B,GAAY,IAAMA,EAAWG,GAAgB,IACxDA,GAAgBH,EAAWC,KAAKC,SAAW,KAE7Cb,EAAQf,MAAM4C,mBAAd,KAAwCnB,EAAxC,OAaJ4B,GA4CA,OA1Ce,SAATI,IACJ,GAAIrC,EACED,IAAOL,EAAkBwC,WAAWG,EAzH1B,UAwHhB,CAIA,IAAIC,EAAS,KACTlC,IAAcP,EAAa0C,QAC7BD,GAAU,MAAME,mBAAmB3C,EAAa0C,OAChDnC,EAAcP,EAAa0C,OAE7BE,MAAM,wDACoDH,EACxDjD,GAECqD,MAAK,SAAAC,GAAG,OAAIA,EAAIC,UAChBF,MAAK,SAAAG,GAAI,OAAIzD,EAASyD,GAAQ,OAC9BH,MAAK,WACC3C,IACAE,IACHA,GAAY,EACZH,EAAcgD,UAAY,GAC1BhD,EAAclB,MAAMmE,QAAU,YAGjCL,MAAK,WACA3C,IAAOL,EAAkBwC,WAAWG,EAAQ,UAEjDW,OAAM,SAAAC,GACAlD,IACLE,GAAY,EACZH,EAAcgD,UAAYG,EAC1BnD,EAAclB,MAAMmE,QAAU,QAC9BjB,QAAQE,MAAMiB,GACdC,MAAM,0JACNC,SAASC,cAGff,GAEAvC,EAAcgD,UAAY,gBAC1BjD,EAAawB,QAEN,WACLtB,GAAQ,EACRa,OAAOyC,qBAAqB7D,GAC5BH,EAAiBiE,QACjBC,aAAa9D,GACb8D,aAAa7D,GACbkB,OAAO4C,oBAAoB,OAAQ7C,GACnCC,OAAO4C,oBAAoB,QAAS1C,GACpCF,OAAO4C,oBAAoB,YAAazC,GACxCH,OAAO4C,oBAAoB,UAAWpC,GACtCR,OAAO4C,oBAAoB,cAAelC,GAC1CV,OAAO4C,oBAAoB,YAAajC,GACxCX,OAAO4C,oBAAoB,aAAc/B,GACzCb,OAAO4C,oBAAoB,WAAY5B,GACvChB,OAAO4C,oBAAoB,YAAa3B,MAIzC,IAGD,uBAAS/C,IAAKA,EAAK2E,MAAO7E,GACxB,YAAC8E,EAAA,EAAD,CAAQC,MAAM,YACd,qBAAO7E,IAAKE,EAAU4E,WAAS,IAC/B,kBAAIH,MAAM,UACPtE,EAAM0E,KAAI,SAAAtF,GAAI,OACb,YAAC,EAAD,CAAUA,KAAMA,EAAMuF,IAAKvF,QAG/B,iBAAGO,IAAKG,EAAWwE,MAAM,eAAzB","file":"route-chat.chunk.f28d8.js","sourcesContent":["// extracted by mini-css-extract-plugin\nexport default {\"chat\":\"chat__whrty\"};","import { FunctionalComponent, createRef, h } from 'preact'\nimport { useEffect, useState } from 'preact/hooks'\nimport Helmet from 'react-helmet'\nimport style from './style.css'\n\ninterface ChatItemProps {\n  item: string;\n}\n\nconst ChatItem: FunctionalComponent<ChatItemProps> = (props: ChatItemProps) => {\n  const { item } = props\n  const color = item.substr(-6)\n  const message = item.substr(0, item.length-6)\n  return <li style={{color: `#${color}`}}>{message}</li>\n}\n\nconst Chat: FunctionalComponent = () => {\n  const ref = createRef<HTMLElement>()\n  const inputRef = createRef<HTMLInputElement>()\n  const statusRef = createRef<HTMLParagraphElement>()\n  const [items, setItems] = useState<string[]>([])\n  const chatFetchAborter = new AbortController()\n\n  useEffect(() => {\n    const element = ref.current as HTMLElement\n    const inputElement = inputRef.current as HTMLInputElement\n    const statusElement = statusRef.current as HTMLParagraphElement\n    const refreshMs = 128\n    let alive = true\n    let paused = false\n    let connected = false\n    let mouseDown = 0\n    let mouseLeftDownY = 0\n    let lastMessage = ''\n    let renderCallbackID: number\n    let renderTimeoutID: ReturnType<typeof setTimeout>\n    let updateTimeoutID: ReturnType<typeof setTimeout>\n    let position = 0\n    let velocity = 4 - 8 * Math.random()\n    let acceleration = 8 - 16 * Math.random()\n    let free = true\n    \n    const handleBlur = (): void => {\n      paused = true\n    }\n    window.addEventListener('blur', handleBlur)\n\n    const handleFocus = (): void => {\n      paused = false\n    }\n    window.addEventListener('focus', handleFocus)\n\n    const handleMouseDown = (event: MouseEvent): boolean => {\n      mouseDown |= (1<<event.button)\n      if (event.button===0) {\n        mouseLeftDownY = event.clientY\n      }\n      event.preventDefault()\n      return false\n    }\n    window.addEventListener('mousedown', handleMouseDown)\n\n    const handleMouseUp = (event: MouseEvent): boolean => {\n      mouseDown ^= (1<<event.button)\n      if (event.button===0) {\n        acceleration = 0\n        velocity *= 2 // flick\n      }\n      inputElement.focus()\n      event.preventDefault()\n      return false\n    }\n    window.addEventListener('mouseup', handleMouseUp)\n\n    const handleContextMenu = (event: MouseEvent): boolean => {\n      event.preventDefault()\n      return false\n    }\n    window.addEventListener('contextmenu', handleContextMenu)\n\n    const handleMouseMove = (event: MouseEvent): void => {\n      if (mouseDown&1) {\n        velocity = event.clientY - mouseLeftDownY\n        mouseLeftDownY = event.clientY\n        position += velocity\n        element.style.backgroundPosition = `0 ${position}px`\n      }\n    }\n    window.addEventListener('mousemove', handleMouseMove)\n\n    const handleTouchDown = (event: TouchEvent): boolean => {\n      void(event)\n      free = false\n      mouseLeftDownY = event.touches[0].pageY\n      return false\n    }\n    window.addEventListener('touchstart', handleTouchDown)\n\n    const handleTouchUp = (event: TouchEvent): boolean => {\n      void(event)\n      free = true\n      acceleration = 0\n      velocity *= 2 // flick\n      return false\n    }\n    window.addEventListener('touchend', handleTouchUp)\n\n    const handleTouchMove = (event: TouchEvent): void => {\n      if (event.touches.length===1) {\n        velocity = event.touches[0].pageY - mouseLeftDownY\n        mouseLeftDownY = event.touches[0].pageY \n        position += velocity\n        element.style.backgroundPosition = `0 ${position}px`\n      }\n      else if (event.touches.length===2) {\n        console.log(event.touches)\n      }\n      else {\n        console.error('Insufficient holes')\n      }\n    }\n    window.addEventListener('touchmove', handleTouchMove)\n\n    const draw = (): void => {\n      if (!(mouseDown&1)&&free) {\n        velocity += acceleration\n        position += velocity\n        // dampen\n        if (Math.abs(velocity) > 32 && velocity * acceleration >= 0) {\n          acceleration = -velocity * Math.random() / 128\n        }\n        element.style.backgroundPosition = `0 ${position}px`\n      }\n    }\n\n    const render = (): void => {\n      if (paused) {\n        renderTimeoutID = setTimeout(render, 512)\n      }\n      else {\n        renderCallbackID = window.requestAnimationFrame(render)\n        draw()\n      }\n    }\n    render()\n\n    const update = (): void => {\n      if (paused) {\n        if (alive) updateTimeoutID = setTimeout(update, refreshMs)\n        return\n      }\n      let params = '?r'\n      if (lastMessage!==inputElement.value) {\n        params += `&s=${encodeURIComponent(inputElement.value)}`\n        lastMessage = inputElement.value\n      }\n      fetch(\n        `https://psilly.com/experiments/ajax/chatter_chat.pill${params}`,\n        chatFetchAborter\n      )\n        .then(res => res.json())\n        .then(data => setItems(data || []))\n        .then(() => {\n          if (!alive) return\n          if (!connected) {\n            connected = true\n            statusElement.innerText = ''\n            statusElement.style.display = 'none'\n          }\n        })\n        .then(() => {\n          if (alive) updateTimeoutID = setTimeout(update, 1028)\n        })\n        .catch(err => {\n          if (!alive) return\n          connected = false\n          statusElement.innerText = err as string\n          statusElement.style.display = 'block'\n          console.error(err)\n          alert('Error connecting to server.\\nYou may have lost your connection, or perhaps you dislike cookies?\\nRefresh the page, with cookies enabled, to try again.')\n          location.reload()\n        })\n    }\n    update()\n\n    statusElement.innerText = 'Connecting...'\n    inputElement.focus()\n\n    return (): void => {\n      alive = false\n      window.cancelAnimationFrame(renderCallbackID)\n      chatFetchAborter.abort()\n      clearTimeout(renderTimeoutID)\n      clearTimeout(updateTimeoutID)\n      window.removeEventListener('blur', handleBlur)\n      window.removeEventListener('focus', handleFocus)\n      window.removeEventListener('mousedown', handleMouseDown)\n      window.removeEventListener('mouseup', handleMouseUp)\n      window.removeEventListener('contextmenu', handleContextMenu)\n      window.removeEventListener('mousemove', handleMouseMove)\n      window.removeEventListener('touchstart', handleTouchDown)\n      window.removeEventListener('touchend', handleTouchUp)\n      window.removeEventListener('touchmove', handleTouchMove)\n    }\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [])\n\n  return (\n    <section ref={ref} class={style.chat}>\n      <Helmet title=\"Chatter\" />\n      <input ref={inputRef} autofocus />\n      <ul class=\"output\">\n        {items.map(item => (\n          <ChatItem item={item} key={item} />\n        ))}\n      </ul>\n      <p ref={statusRef} class=\"text-center\">A colourful ape input aggregator.</p>\n    </section>\n  )\n}\n\nexport default Chat\n"],"sourceRoot":""}